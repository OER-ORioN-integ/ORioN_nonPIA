{
  "name" : "orion_prd_etl-job_datalink_test_ut_double_data",
  "jobMode" : "VISUAL",
  "description" : "",
  "role" : "arn:aws:iam::142980225941:role/orion_prd_glue-role",
  "executionProperty" : {
    "maxConcurrentRuns" : 1
  },
  "command" : {
    "name" : "glueetl",
    "scriptLocation" : "s3://orion-prd-etljob/scripts/orion_prd_etl-job_datalink_test_ut_double_data.py",
    "pythonVersion" : "3"
  },
  "defaultArguments" : {
    "--enable-metrics" : "true",
    "--extra-py-files" : "s3://aws-glue-studio-transforms-200493242866-prod-ap-northeast-1/gs_common.py,s3://aws-glue-studio-transforms-200493242866-prod-ap-northeast-1/gs_now.py",
    "--spark-event-logs-path" : "s3://orion-prd-etljob/sparkHistoryLogs/",
    "--enable-job-insights" : "false",
    "--enable-observability-metrics" : "true",
    "--enable-glue-datacatalog" : "true",
    "--enable-continuous-cloudwatch-log" : "true",
    "--SOURCE_SYSTEM" : "TEST",
    "--job-bookmark-option" : "job-bookmark-disable",
    "--DATA_NAME" : "mk_parquet",
    "--job-language" : "python",
    "--TempDir" : "s3://orion-prd-etljob/tmp/"
  },
  "maxRetries" : 0,
  "allocatedCapacity" : 2,
  "timeout" : 2880,
  "maxCapacity" : 2.0,
  "glueVersion" : "4.0",
  "numberOfWorkers" : 2,
  "workerType" : "G.1X",
  "executionClass" : "STANDARD",
  "codeGenConfigurationNodes" : "{\"node-1728644991304\":{\"CustomCode\":{\"ClassName\":\"MyTransformUsagePoint\",\"Code\":\"from decimal import Decimal, InvalidOperation\\nfrom pyspark.sql.functions import udf\\nfrom pyspark.sql.types import StringType\\n\\n# ポイント丸めの入力項目名と出力項目名の配列\\n入力項目名リスト = [\\\"point\\\", \\\"point_decimal\\\"]\\n出力項目名リスト = [\\\"point_aft\\\", \\\"point_decimal_aft\\\"]\\n\\n# 備考として追加する項目名の配列\\n追加項目名リスト = [\\\"point_note\\\", \\\"point_decimal_note\\\"]\\n### 作成時の修正箇所ここまで ###\\n\\n# メインパラメータ\\ntop = 1000\\n\\n# ポイント丸め\\ndef convert_point(point, top):\\n    if point is None:\\n        return None\\n\\n    # string型なら Decimal型 に変換、int型や小数型ならそのまま。空文字は例外対応\\n    try:\\n        tmp_point = Decimal(point) if isinstance(point, str) else point\\n    except InvalidOperation:\\n        return None\\n\\n    if tmp_point >= top:\\n        return top\\n    else:\\n        return point\\n\\n# ポイント層備考\\ndef convert_point_memo(point, top):\\n    if point is None:\\n        return \\\"－\\\"\\n\\n    # string型なら Decimal型 に変換、int型や小数型ならそのまま。空文字は例外対応\\n    try:\\n        tmp_point = Decimal(point) if isinstance(point, str) else point\\n    except InvalidOperation:\\n        return \\\"－\\\"\\n\\n    if tmp_point >= top:\\n        return f\\\"{top}ポイント以上\\\"\\n    else:\\n        return \\\"－\\\"\\n\\n# UDFの定義\\nconvert_udf_point = udf(lambda point: convert_point(point, top), StringType())\\nconvert_udf_memo = udf(lambda point: convert_point_memo(point, top), StringType())\\n\\n# DataFrameの取得\\ndf = dfc.select(list(dfc.keys())[0]).toDF()\\n\\n# ループ処理で各項目を変換（ポイント丸め）\\nfor 入力項目名, 出力項目名 in zip(入力項目名リスト, 出力項目名リスト):\\n    df = df.withColumn(出力項目名, convert_udf_point(df[入力項目名]))\\n\\n# ループ処理で各項目の備考を追加\\nfor 入力項目名, 追加項目名 in zip(入力項目名リスト, 追加項目名リスト):\\n    df = df.withColumn(追加項目名, convert_udf_memo(df[入力項目名]))\\n\\n# DynamicFrameに変換して返す\\noutput_dyf = DynamicFrame.fromDF(df, glueContext, \\\"output\\\")\\nreturn DynamicFrameCollection({\\\"CustomTransform0\\\": output_dyf}, glueContext)\\n     \",\"Inputs\":[\"node-1728558426190\"],\"Name\":\"【加工】ポイント加工（上限丸め）\",\"OutputSchemas\":[{\"Columns\":[{\"Name\":\"id\",\"Type\":\"int\"},{\"Name\":\"pattern\",\"Type\":\"string\"},{\"Name\":\"masking\",\"Type\":\"string\"},{\"Name\":\"hashing\",\"Type\":\"string\"},{\"Name\":\"birthday\",\"Type\":\"string\"},{\"Name\":\"age\",\"Type\":\"string\"},{\"Name\":\"amount\",\"Type\":\"int\"},{\"Name\":\"point\",\"Type\":\"int\"},{\"Name\":\"amount_decimal\",\"Type\":\"string\"},{\"Name\":\"point_decimal\",\"Type\":\"string\"},{\"Name\":\"date\",\"Type\":\"string\"},{\"Name\":\"date8\",\"Type\":\"string\"},{\"Name\":\"timestamp\",\"Type\":\"string\"},{\"Name\":\"hhmm\",\"Type\":\"string\"},{\"Name\":\"amount_aft\",\"Type\":\"string\"},{\"Name\":\"amount_decimal_aft\",\"Type\":\"string\"},{\"Name\":\"amount_note\",\"Type\":\"string\"},{\"Name\":\"amount_decimal_note\",\"Type\":\"string\"},{\"Name\":\"point_aft\",\"Type\":\"string\"},{\"Name\":\"point_decimal_aft\",\"Type\":\"string\"},{\"Name\":\"point_note\",\"Type\":\"string\"},{\"Name\":\"point_decimal_note\",\"Type\":\"string\"}]}]}},\"node-1728645644174\":{\"SelectFromCollection\":{\"Index\":0,\"Inputs\":[\"node-1728644991304\"],\"Name\":\"【加工時必須】加工後処理（ポイント加工（上限丸め））\"}},\"node-1728558426190\":{\"SelectFromCollection\":{\"Index\":0,\"Inputs\":[\"node-1728558322674\"],\"Name\":\"【加工時必須】加工後処理（金額加工（上限下限丸め））\"}},\"node-1728638294884\":{\"CustomCode\":{\"ClassName\":\"MyTransformOutputOneFileCsv\",\"Code\":\"from datetime import datetime\\n\\nimport boto3\\nfrom awsglue.utils import getResolvedOptions\\nfrom pyspark.sql import DataFrame\\n\\n### 作成時の修正箇所ここから ###\\n#  本ノードは作成時のパラメータ設定不要です。このままお使いください。\\n### 作成時の修正箇所ここまで ###\\n\\nprint(f\\\"{datetime.strftime(datetime.now(), '%Y/%m/%dT%H:%M:%S')} INFO (MyTransformOutputOneFileCsv) start\\\")\\n\\n# Glueジョブ引数の取得\\nglue_params = getResolvedOptions(sys.argv, [\\\"SOURCE_SYSTEM\\\", \\\"DATA_NAME\\\"])\\nprint(f\\\"{datetime.strftime(datetime.now(), '%Y/%m/%dT%H:%M:%S')} DEBUG (MyTransformOutputOneFileCsv) glue_params:{glue_params}\\\")\\n\\n# 連携元システム名（DMP/ONE/OCTPASS）\\nsource_system = glue_params.get(\\\"SOURCE_SYSTEM\\\", None)\\n# データ名（物理テーブル名）\\ndata_name = glue_params.get(\\\"DATA_NAME\\\", None)\\n\\n# プレフィックスヘッド\\nprefix_head = f\\\"{source_system}/{data_name}\\\"\\n\\n# 作業用バケット\\nwork_bucket = \\\"orion-prd-work\\\"\\n# workディレクトリ\\nwork_dir = f\\\"{prefix_head}/dwh_work/\\\"\\n# 一時出力先s3パス\\nwork_s3_path = f\\\"s3://{work_bucket}/{work_dir}\\\"\\n\\n# DataFrameの取得\\ndf = dfc.select(list(dfc.keys())[0]).toDF()\\n\\n# workディレクトリにCSV形式で出力\\ndf.coalesce(1).write.options(encoding=\\\"UTF-8\\\", lineSep=\\\"\\\\n\\\", sep=\\\",\\\", quoteAll=True, header=True).mode(\\\"overwrite\\\").csv(work_s3_path)\\n\\n# 関数定義\\ndef get_process_timestamp_from_df(df: DataFrame, column_name: str) -> str:\\n    \\\"\\\"\\\"DFからデータ統合基盤処理日時 文字列を取得する\\n    Args:\\n        df (pysoar.sql.DataFrame): データフレーム\\n        column_name (str): データ統合基盤処理日時項目名\\n    Returns:\\n        str: yyyymmddhhmmss\\n    \\\"\\\"\\\"\\n    # JSTタイムスタンプカラムの値を取得（yyyy/mm/dd hh:mm:ss形式）\\n    orion_process_datetm = df.select(column_name).first()[0]\\n    # yyyymmddhhmmss形式に変換\\n    res_datetm_str = datetime.strptime(orion_process_datetm, \\\"%Y/%m/%d %H:%M:%S\\\").strftime(\\\"%Y%m%d%H%M%S\\\")\\n    return res_datetm_str\\n\\n# ■実行日時をJSTのyyyyymmddhhmmss文字列に変換\\n# DFの処理日時項目名\\nORION_PROCESS_DATETM = \\\"orion_process_datetm\\\"\\nexecute_timestamp_str = get_process_timestamp_from_df(df=df, column_name=ORION_PROCESS_DATETM)\\nprint(f\\\"{datetime.strftime(datetime.now(), '%Y/%m/%dT%H:%M:%S')} DEBUG (get_process_timestamp_from_df) execute_timestamp_str:{execute_timestamp_str}\\\")\\n\\n# DM_Bdashバケット\\ndm_bdash_bucket = \\\"orion-prd-dm-bdash\\\"\\n# 連携先ディレクトリ\\noutput_prefix = f\\\"{source_system}/{data_name}\\\"\\n# 連携ファイル名\\nfile_name = f\\\"{data_name}_{execute_timestamp_str}.csv\\\"\\n# 連携先key\\nfile_key = f\\\"{output_prefix}/{file_name}\\\"\\n\\n# S3クライアントを使用してworkフォルダに出力したファイルをリネームして移動\\ns3 = boto3.client(\\\"s3\\\")\\nresponse = s3.list_objects_v2(Bucket=work_bucket, Prefix=work_dir)\\nfor obj in response.get(\\\"Contents\\\", []):\\n    if obj[\\\"Key\\\"].endswith(\\\".csv\\\"):\\n        copy_source = {\\\"Bucket\\\": work_bucket, \\\"Key\\\": obj[\\\"Key\\\"]}\\n        print(f\\\"{datetime.strftime(datetime.now(), '%Y/%m/%dT%H:%M:%S')} DEBUG (MyTransformOutputOneFileCsv) copy_source:{copy_source}, dm_bdash_bucket:{dm_bdash_bucket}, file_key:{file_key}\\\")\\n        s3.copy_object(CopySource=copy_source, Bucket=dm_bdash_bucket, Key=file_key)\\n        s3.delete_object(Bucket=work_bucket, Key=obj[\\\"Key\\\"])\\n        break\\n\\nprint(f\\\"{datetime.strftime(datetime.now(), '%Y/%m/%dT%H:%M:%S')} INFO (MyTransformOutputOneFileCsv) end\\\")\",\"Inputs\":[\"node-1730279185825\"],\"Name\":\"【必須】１ファイルでb→dash向けDMバケットへ出力\"}},\"node-1730278909444\":{\"DropFields\":{\"Inputs\":[\"node-1733443362183\"],\"Name\":\"【加工】非連携項目の削除\",\"Paths\":[]}},\"node-1733443362183\":{\"DynamicTransform\":{\"FunctionName\":\"gs_now\",\"Inputs\":[\"node-1728645644174\"],\"Name\":\"Add Current Timestamp\",\"OutputSchemas\":[{\"Columns\":[{\"Name\":\"id\",\"Type\":\"int\"},{\"Name\":\"pattern\",\"Type\":\"string\"},{\"Name\":\"masking\",\"Type\":\"string\"},{\"Name\":\"hashing\",\"Type\":\"string\"},{\"Name\":\"birthday\",\"Type\":\"string\"},{\"Name\":\"age\",\"Type\":\"string\"},{\"Name\":\"amount\",\"Type\":\"string\"},{\"Name\":\"point\",\"Type\":\"string\"},{\"Name\":\"amount_decimal\",\"Type\":\"string\"},{\"Name\":\"point_decimal\",\"Type\":\"string\"},{\"Name\":\"date\",\"Type\":\"string\"},{\"Name\":\"date8\",\"Type\":\"string\"},{\"Name\":\"timestamp\",\"Type\":\"string\"},{\"Name\":\"hhmm\",\"Type\":\"string\"},{\"Name\":\"amount_note\",\"Type\":\"string\"},{\"Name\":\"amount_decimal_note\",\"Type\":\"string\"},{\"Name\":\"point_note\",\"Type\":\"string\"},{\"Name\":\"point_decimal_note\",\"Type\":\"string\"},{\"Name\":\"orion_process_datetm\",\"Type\":\"string\"}]}],\"Parameters\":[{\"IsOptional\":true,\"Name\":\"colName\",\"Type\":\"str\",\"Value\":[\"orion_process_datetm\"]},{\"IsOptional\":true,\"Name\":\"dateFormat\",\"Type\":\"str\",\"Value\":[\"%Y/%m/%d %H:%M:%S\"]}],\"Path\":\"s3://aws-glue-studio-transforms-200493242866-prod-ap-northeast-1/gs_now.py\",\"TransformName\":\"gs_now\",\"Version\":\"1.0.0\"}},\"node-1727682543308\":{\"S3ParquetSource\":{\"AdditionalOptions\":{\"EnableSamplePath\":false,\"SamplePath\":\"s3://orion-prd-work/TEST/mk_parquet/raw_dwh/run-1733450212773-part-block-0-r-00000-snappy.parquet\"},\"Exclusions\":[],\"Name\":\"【必須】連携された正則化済データ\",\"OutputSchemas\":[{\"Columns\":[{\"Name\":\"id\",\"Type\":\"int\"},{\"Name\":\"pattern\",\"Type\":\"string\"},{\"Name\":\"masking\",\"Type\":\"string\"},{\"Name\":\"hashing\",\"Type\":\"string\"},{\"Name\":\"birthday\",\"Type\":\"string\"},{\"Name\":\"age\",\"Type\":\"string\"},{\"Name\":\"amount\",\"Type\":\"int\"},{\"Name\":\"point\",\"Type\":\"int\"},{\"Name\":\"amount_decimal\",\"Type\":\"string\"},{\"Name\":\"point_decimal\",\"Type\":\"string\"},{\"Name\":\"date\",\"Type\":\"string\"},{\"Name\":\"date8\",\"Type\":\"string\"},{\"Name\":\"timestamp\",\"Type\":\"string\"},{\"Name\":\"hhmm\",\"Type\":\"string\"}]}],\"Paths\":[\"s3://orion-prd-work/TEST/mk_parquet/raw_dwh/\"]}},\"node-1730279185825\":{\"SelectFromCollection\":{\"Index\":0,\"Inputs\":[\"node-1730279130441\"],\"Name\":\"【加工時必須】加工後処理（項目順序の並替え）\"}},\"node-1728558322674\":{\"CustomCode\":{\"ClassName\":\"MyTransformUsageAmount\",\"Code\":\"from decimal import Decimal, InvalidOperation\\nfrom pyspark.sql.functions import udf\\nfrom pyspark.sql.types import StringType\\n\\n### 作成時の修正箇所ここから ###\\n# 金額丸めの入力項目名と出力項目名の配列\\n入力項目名リスト = [\\\"amount\\\", \\\"amount_decimal\\\"]\\n出力項目名リスト = [\\\"amount_aft\\\", \\\"amount_decimal_aft\\\"]\\n\\n# 備考として追加する項目名の配列\\n追加項目名リスト = [\\\"amount_note\\\", \\\"amount_decimal_note\\\"]\\n### 作成時の修正箇所ここまで ###\\n\\n# メインパラメータ\\ntop = 100000\\nbottom = 99\\n\\n# 金額丸め\\ndef convert_amount(amount, top, bottom):\\n    # NullならNullを返す\\n    if amount is None:\\n        return None\\n\\n    # string型なら Decimal型 に変換、int型や小数型ならそのまま。空文字は例外対応。空文字は例外対応\\n    try:\\n        tmp_amount = Decimal(amount) if isinstance(amount, str) else amount\\n    except InvalidOperation:\\n        return None\\n        \\n    if tmp_amount <= Decimal(bottom):\\n        return bottom\\n    elif tmp_amount >= Decimal(top):\\n        return top\\n    else:\\n        return amount\\n\\n# 金額層備考\\ndef convert_amount_memo(amount, top, bottom):\\n    # Nullなら\\\"-\\\"を返す\\n    if amount is None:\\n        return \\\"－\\\"\\n\\n    # string型なら Decimal型 に変換、int型や小数型ならそのまま。空文字は例外対応。空文字は例外対応\\n    try:\\n        tmp_amount = Decimal(amount) if isinstance(amount, str) else amount\\n    except InvalidOperation:\\n        return \\\"－\\\"\\n\\n    if tmp_amount <= Decimal(bottom):\\n        return f\\\"{bottom}円以下\\\"\\n    elif tmp_amount >= Decimal(top):\\n        return f\\\"{top}円以上\\\"\\n    return \\\"－\\\"\\n\\n# UDFの定義\\nconvert_udf_amount = udf(lambda amount: convert_amount(amount, top, bottom), StringType())\\nconvert_udf_memo = udf(lambda amount: convert_amount_memo(amount, top, bottom), StringType())\\n\\n# DataFrameの取得\\ndf = dfc.select(list(dfc.keys())[0]).toDF()\\n\\n# ループ処理で各項目を変換（金額丸め）\\nfor 入力項目名, 出力項目名 in zip(入力項目名リスト, 出力項目名リスト):\\n    df = df.withColumn(出力項目名, convert_udf_amount(df[入力項目名]))\\n\\n# ループ処理で各項目の備考を追加\\nfor 入力項目名, 追加項目名 in zip(入力項目名リスト, 追加項目名リスト):\\n    df = df.withColumn(追加項目名, convert_udf_memo(df[入力項目名]))\\n\\n# DynamicFrameに変換して返す\\noutput_dyf = DynamicFrame.fromDF(df, glueContext, \\\"output\\\")\\nreturn DynamicFrameCollection({\\\"CustomTransform0\\\": output_dyf}, glueContext)\",\"Inputs\":[\"node-1727682543308\"],\"Name\":\"【加工】金額加工（上限下限丸め）\",\"OutputSchemas\":[{\"Columns\":[{\"Name\":\"id\",\"Type\":\"int\"},{\"Name\":\"pattern\",\"Type\":\"string\"},{\"Name\":\"masking\",\"Type\":\"string\"},{\"Name\":\"hashing\",\"Type\":\"string\"},{\"Name\":\"birthday\",\"Type\":\"string\"},{\"Name\":\"age\",\"Type\":\"string\"},{\"Name\":\"amount\",\"Type\":\"int\"},{\"Name\":\"point\",\"Type\":\"int\"},{\"Name\":\"amount_decimal\",\"Type\":\"string\"},{\"Name\":\"point_decimal\",\"Type\":\"string\"},{\"Name\":\"date\",\"Type\":\"string\"},{\"Name\":\"date8\",\"Type\":\"string\"},{\"Name\":\"timestamp\",\"Type\":\"string\"},{\"Name\":\"hhmm\",\"Type\":\"string\"},{\"Name\":\"amount_aft\",\"Type\":\"string\"},{\"Name\":\"amount_decimal_aft\",\"Type\":\"string\"},{\"Name\":\"amount_note\",\"Type\":\"string\"},{\"Name\":\"amount_decimal_note\",\"Type\":\"string\"}]}]}},\"node-1730279130441\":{\"CustomCode\":{\"ClassName\":\"MyTransformSortFeilds\",\"Code\":\"from awsglue.dynamicframe import DynamicFrame, DynamicFrameCollection\\n\\n### 作成時の修正箇所ここから ###\\n# 並び替えたい順序で全項目名を記載する\\n項目順序 = [\\n    \\\"id\\\", \\\"pattern\\\", \\\"masking\\\", \\\"hashing\\\", \\n    \\\"birthday\\\", \\\"age\\\", \\n    \\\"amount\\\", \\\"amount_aft\\\", \\\"amount_note\\\", \\n    \\\"amount_decimal\\\", \\\"amount_decimal_aft\\\", \\\"amount_decimal_note\\\", \\n    \\\"point\\\", \\\"point_aft\\\", \\\"point_note\\\", \\n    \\\"point_decimal\\\", \\\"point_decimal_aft\\\", \\\"point_decimal_note\\\", \\n    \\\"date\\\", \\\"date8\\\", \\\"timestamp\\\", \\\"hhmm\\\", \\\"orion_process_datetm\\\"\\n]\\n### 作成時の修正箇所ここまで ###\\n\\n# DataFrameの取得\\ndf = dfc.select(list(dfc.keys())[0]).toDF()\\n\\n# 指定した順序でDataFrameのカラムを並び替え\\ndf = df.select(項目順序)\\n\\n# DynamicFrameに変換して返す\\noutput_dyf = DynamicFrame.fromDF(df, glueContext, \\\"output\\\")\\nreturn DynamicFrameCollection({\\\"CustomTransform0\\\": output_dyf}, glueContext)\\n\",\"Inputs\":[\"node-1730278909444\"],\"Name\":\"【加工】項目順序の並替え\",\"OutputSchemas\":[{\"Columns\":[{\"Name\":\"id\",\"Type\":\"int\"},{\"Name\":\"pattern\",\"Type\":\"string\"},{\"Name\":\"masking\",\"Type\":\"string\"},{\"Name\":\"hashing\",\"Type\":\"string\"},{\"Name\":\"birthday\",\"Type\":\"string\"},{\"Name\":\"age\",\"Type\":\"string\"},{\"Name\":\"amount\",\"Type\":\"string\"},{\"Name\":\"amount_note\",\"Type\":\"string\"},{\"Name\":\"amount_decimal\",\"Type\":\"string\"},{\"Name\":\"amount_decimal_note\",\"Type\":\"string\"},{\"Name\":\"point\",\"Type\":\"string\"},{\"Name\":\"point_note\",\"Type\":\"string\"},{\"Name\":\"point_decimal\",\"Type\":\"string\"},{\"Name\":\"point_decimal_note\",\"Type\":\"string\"},{\"Name\":\"date\",\"Type\":\"string\"},{\"Name\":\"date8\",\"Type\":\"string\"},{\"Name\":\"timestamp\",\"Type\":\"string\"},{\"Name\":\"hhmm\",\"Type\":\"string\"}]}]}}}",
  "sourceControlDetails" : {
    "provider" : "GITHUB",
    "repository" : "ORioN_nonPIA",
    "branch" : "master",
    "folder" : "test"
  }
}